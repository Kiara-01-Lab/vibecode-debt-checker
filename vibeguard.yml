name: vibeguard

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write

jobs:
  vibeguard-check:
    name: Security & Quality Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      # ── Secret scan ─────────────────────────────────────────
      - name: Scan for hardcoded secrets
        run: npx tsx src/utils/check.ts

      # ── TypeScript type check ───────────────────────────────
      - name: Type check
        run: npx tsc --noEmit

      # ── Verify .env.example exists ──────────────────────────
      - name: Check .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "::error::Missing .env.example — new contributors need this file"
            exit 1
          fi

      # ── Verify .gitignore covers .env ───────────────────────
      - name: Check .gitignore covers secrets
        run: |
          if ! grep -q "\.env" .gitignore 2>/dev/null; then
            echo "::error::.gitignore does not include .env — secrets may be committed"
            exit 1
          fi

      # ── Check for debug/unsafe patterns ─────────────────────
      - name: Check for unsafe patterns
        run: |
          ISSUES=0

          # Check for eval() usage
          if grep -rn "eval(" src/ --include="*.ts" --include="*.js" | grep -v "node_modules" | grep -v "\.d\.ts"; then
            echo "::warning::eval() detected — this is a code injection risk"
            ISSUES=$((ISSUES + 1))
          fi

          # Check for wildcard CORS in non-dev code
          if grep -rn "origin:\s*['\"]?\*['\"]?" src/ --include="*.ts" --include="*.js" | grep -v "node_modules"; then
            echo "::warning::Wildcard CORS origin detected — lock this down for production"
            ISSUES=$((ISSUES + 1))
          fi

          # Check for console.log (should use structured logger)
          CONSOLE_LOGS=$(grep -rn "console\.\(log\|warn\|error\)" src/ --include="*.ts" --include="*.js" | grep -v "node_modules" | grep -v "check.ts" | wc -l)
          if [ "$CONSOLE_LOGS" -gt 0 ]; then
            echo "::warning::Found $CONSOLE_LOGS console.log calls — use the structured logger instead"
            ISSUES=$((ISSUES + 1))
          fi

          echo "Found $ISSUES potential issues"
          # Warnings only — don't fail the build for these
